# PR review manager

Сервис для назначения ревьюверов на Pull Request’ы (PR), управления командами и пользователями.

### Возможности сервиса:

- Создание команд с участниками (создание/обновление пользователей).
- Получение полной информации о команде.
- Управление активностью пользователей.
- Создание PR.
- Переназначение ревьювера на PR.
- Получение PR’ов, где конкретный пользователь назначен ревьювером.
- Пометка PR как MERGED (идемпотентная операция).

### Используемые технологии:

- Go 1.25
- PostgreSQL 18.0
- Docker / Docker Compose

### Конфигурация

Приложение использует конфигурационный файл, путь к которому задаётся переменной окружения `CONFIG_PATH`.

Готовые примеры находятся в директории `configs/` (например, `configs/local.yaml`).

### Запуск с помощью Docker Compose

Запускает сервис и PostgreSQL через Docker Compose.

Из корня проекта выполните команду:

```bash
docker compose up -d
```

Или используйте Makefile:

```bash
make run-app
```

После запуска:

- сервис будет доступен по адресу: `http://localhost:8080`.
- PostgreSQL доступен по адресу: `localhost:5432` (учётные данные из `configs/docker.yaml`)

### Остановка приложения и удаление контейнеров

Для остановки приложения и удаления контейнеров выполните команду:

```bash
make stop-app
```

### Запуск с поднятой PostgreSQL вручную

1. Укажите собственные настройки подключения к БД в конфигурационном файле (например, `configs/local.yaml`).

2. Создайте базу данных:

    ```sql
    CREATE DATABASE pr_manager_db;
    ```

3. Выполните миграции:
    ```bash
    make migrate-up
    ```
   По умолчанию используется configs/local.yaml.

   Чтобы указать другой файл конфигурации:
      ```bash
      CONFIG_PATH=./configs/your_config.yaml make migrate-up
      ```

4. Запустите приложение:
    ```bash
    CONFIG_PATH=./configs/local.yaml go run ./cmd/app
    ```
   Или с кастомным конфигом:
    ```bash
    CONFIG_PATH=./configs/your_config.yaml go run ./cmd/app
    ```

### API

Спецификация описана в файле `api/openapi/openapi.yaml`.

Доступные эндпоинты:

- POST /team/add — создать команду

- GET /team/get — получить команду

- POST /team/deactivate - деактивировать участников команды и если на них назначены PR, то переназначить на активных участников

- POST /pullRequest/create — создать PR и назначить ревьюверов

- POST /pullRequest/reassign — переназначить ревьювера

- POST /pullRequest/merge — отметить PR как MERGED

- GET /users/getReview — получить PR’ы пользователя

- POST /users/setIsActive — изменить активность пользователя

### Тестирование

#### Юнит-тестирование

Для запуска юнит-тестов выполните команду:

```bash
make unit-test
```

#### Интеграционное тестирование

Для запуска интеграционных тестов выполните команду:

```bash
make integration-test
```

Во время выполнения тестов будет поднято тестовое окружение с PostgreSQL в Docker-контейнерах.

После завершения тестов окружение будет автоматически удалено.

## Вопросы / проблемы

### Авторизация

В первой версии OpenAPI-спецификации предусматривалась авторизация с использованием административного токена. 
На основании этого был реализован middleware для проверки заголовка `X-Admin-Token`.
Значение токена администратора задаётся в конфигурационном файле.
